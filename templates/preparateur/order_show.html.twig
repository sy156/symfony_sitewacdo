{% extends 'base.html.twig' %}

{% block title %}Détails de la commande #{{ order.id }}
{% endblock %}

{% block body %}
	<div class="container-fluid p-4">

		<h1 class="mb-4">Commande #{{ order.id }}</h1>

		{# Flash messages #}
		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ label == 'success' ? 'success' : 'danger' }} alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}
		{% endfor %}

		<div
			class="row">
			{# Informations générales #}
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Informations générales</h5>
						<p>
							<strong>Client :</strong>
							{{ order.user ? order.user.email : 'Numéro fictif: CMD-' ~ '%04d'|format(order.id) }}</p>
						<p>
							<strong>Total :</strong>
							{{ order.total }}
							€</p>
						<p>
							<strong>Statut :</strong>
							<span class="badge {{ order.getStatutClass() }}">{{ order.getStatutLabel() }}</span>
						</p>
						<p>
							<strong>Créée le :</strong>
							{{ order.createdAt|date('d/m/Y H:i') }}</p>
					</div>
				</div>
			</div>

			{# Ajouter un item #}
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Ajouter un item</h5>
						{{ form_start(itemForm) }}
						{{ form_row(itemForm.product) }}
						{{ form_row(itemForm.quantity) }}
						<button type="submit" class="btn btn-primary mt-2">Ajouter</button>
						{{ form_end(itemForm) }}
					</div>
				</div>
			</div>

			{# Changer le statut #}
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Mettre à jour le statut</h5>
						{{ form_start(statutForm) }}
						{{ form_row(statutForm.statut) }}
						<button type="submit" class="btn btn-success mt-2">Mettre à jour</button>
						{{ form_end(statutForm) }}
					</div>
				</div>
			</div>
		</div>

		{# Contenu de la commande #}
		<div class="card shadow-sm">
			<div class="card-body">
				<h5 class="card-title">Contenu de la commande</h5>
				<table class="table table-striped table-hover">
					<thead class="table-dark">
						<tr>
							<th>Produit</th>
							<th>Quantité</th>
							<th>Prix unitaire</th>
							<th>Total</th>
						</tr>
					</thead>
					<tbody>
						{% for item in order.items %}
							<tr>
								<td>{{ item.product.name }}</td>
								<td>{{ item.quantity }}</td>
								<td>{{ item.product.price|number_format(2, ',', '.') }}
									€</td>
								<td>{{ (item.product.price * item.quantity)|number_format(2, ',', '.') }}
									€</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="4" class="text-center">Aucun produit ajouté</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

		{# Actions pour préparateur #}
		<div class="mt-3 d-flex gap-2">
			{% if order.isEnCours() %}
				<form action="{{ path('preparateur_order_prepare', {id: order.id}) }}" method="post" style="display:inline-block">
					<input type="hidden" name="_token" value="{{ csrf_token('prepare' ~ order.id) }}">
					<button type="submit" class="btn btn-sm btn-primary" onclick="return confirm('Mettre cette commande en préparation ?')">
						Mettre en Préparation</button>
				</form>

			{% endif %}
			{% if order.isEnPreparation() %}
				<form action="{{ path('preparateur_order_deliver', {id: order.id}) }}" method="post" style="display:inline-block">
					<input type="hidden" name="_token" value="{{ csrf_token('deliver' ~ order.id) }}">
					<button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Livrer cette commande ?')">Livrer</button>
				</form>
			{% endif %}

			{% if not order.isLivree() %}
				<form action="{{ path('preparateur_order_cancel', {id: order.id}) }}" method="post" style="display:inline">
					<input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ order.id) }}">
					<button class="btn btn-sm btn-danger" onclick="return confirm('Annuler cette commande ?');">Annuler</button>
				</form>

			{% endif %}
		</div>

		<div class="mt-3">
			<a href="{{ path('preparateur_order_list') }}" class="btn btn-secondary">
				<i class="bi bi-arrow-left-circle"></i>
				Retour aux commandes
			</a>
		</div>

	</div>
{% endblock %}
